# finally-recursion-threat
# Рекурсия в `finally`: оружие из ничего

> Я не так давно познакомился с Java. В процессе изучения материала, особенно раздела по `try-catch-finally`, мне в голову пришла необычная идея. Я решил обсудить её со своей другом, с которой мы вместе разбираемся в тонкостях языка и архитектуры приложений. Мы пришли к интересному выводу: блок `finally`, который должен гарантировать безопасность и завершение, может быть использован как троянская точка входа для перегрузки системы. Это не просто гипотеза — это потенциальная модель угрозы.

---

## Как всё началось

Во время изучения механики `finally` я задумался: что произойдёт, если там будет не просто чистка ресурсов, а бесконечная рекурсия с массивами и загрузкой памяти? Это ведь часть кода, которая всегда выполняется. Именно в этот момент зародилась идея, которую мы развернули и протестировали вместе.

1. `finally` гарантированно выполняется → спецификация не допускает «пропуска» этого блока.
2. Рекурсия без базы вызовов выходит за рамки разумного — выстреливает в стек.
3. Добавляем создание массива внутри `finally` → нагрузка на память.
4. Вывод: это не просто баг — это схема, которую можно обернуть в атаку.

---

## Что уже известно

* StackOverflow обсуждает рекурсию внутри `finally` как антипаттерн, не как угрозу: [stackoverflow.com](https://stackoverflow.com/questions/55756193/recursion-within-a-try-catch-finally-block-how-to-only-call-the-finally-block-o)
* MITRE CWE-674: Uncontrolled Recursion — отмечает рекурсию как возможный вектор для DoS-атак: [cwe.mitre.org](https://cwe.mitre.org/data/definitions/674.html)
* Но: нет случаев, где `finally + рекурсия + нагрузка на heap + команды ОС` рассматривались как целостная модель угрозы. Мы — среди первых, кто это осмыслил комплексно.

---

## Наш эксперимент

```java
import java.util.Random;

public class Doom {
    public static void call(int depth) {
        try {
            System.out.println("Level: " + depth);
            long[] a = new long[10000];
            Random r = new Random();
            for (int i = 0; i < a.length; i++) {
                a[i] = r.nextLong();
            }
        } finally {
            call(depth + 1); 
        }
    }

    public static void main(String[] args) {
        call(0);
    }
}
```

### Что делает код:

* Рекурсивно вызывает сам себя без условий выхода
* Создаёт массивы и заполняет случайными значениями
* Загружает стек и heap одновременно
* Блок `finally` делает это неизбежным

---

## Потенциальный вред

* StackOverflow через несколько сотен вызовов
* Перегрузка памяти (heap overflow)
* Возможность добавить:

  * `Runtime.getRuntime().exec("shutdown -s")`
  * `Robot` для имитации нажатий клавиш (например, Delete)
  * Самоудаление

---

## Почему антивирус может проигнорировать

* Нет вирусной сигнатуры
* Поведение напоминает баг, а не вредонос
* Рекурсия в `finally` — выглядит как ошибка
* Массивы + Random — тоже обычные действия
* Вред возникает только при исполнении, поведенческий анализ не всегда срабатывает

---

## Android — особая зона риска

* Android использует Java-подобную среду (Dalvik/ART)
* Весь код переносим один к одному
* RAM у телефона ниже → устройство перегружается быстрее
* Если встроить в `.apk`, ждать соединения с сетью, а потом:

  * Отправлять данные в облако
  * Запускать скрипт на подключённом к телефону ПК

---

## Модель угрозы (Threat Model)

1. Заражённый файл с `finally + рекурсией`
2. Массивы + Random → нагрузка
3. Отсутствие условия выхода
4. Возможные действия после запуска:

   * Выключение системы
   * Самоудаление
   * Перенос на другие устройства через Telegram, облака и автосинхронизацию

---

## Дополнение: что если Java не установлена?

* Если на компьютере нет JVM, Java-программа не запустится напрямую — это правда.
* Но современные инструменты, такие как **GraalVM Native Image** и **jpackage**, позволяют упаковать Java-код в нативный исполняемый файл, который работает без установки Java.
* Таким образом, **ограничение "нужна Java" можно обойти** — злоумышленник может распространять такой файл как обычное приложение.

---

## Почему важно помнить об «если бы»

* Любая защитная мера имеет **свои обходы** — и ограничение среды исполнения не исключение.
* Если у злоумышленника есть идея и ресурсы, он найдёт способ адаптировать вредоносный код под нужную платформу.
* Поэтому стоит смотреть не только на технические детали, но и на **архитектуру угрозы в целом** — как код взаимодействует с системой, что может вызвать, как распространяется.

---

## Ограничения и возможные возражения

1. **«Если у пользователя нет Java, код не запустится»** — правда, но современные инструменты (GraalVM Native Image, jpackage) позволяют упаковать Java-программу в нативный исполняемый файл, который запускается без JVM.
2. **«Рекурсия в finally — это ошибка, а не уязвимость»** — да, это антипаттерн, но злоумышленник может использовать этот механизм для атаки.
3. **«Современные JVM и ОС остановят процесс при перегрузке»** — обычно так, но на слабых или неправильно настроенных устройствах последствия могут быть серьёзнее.
4. **«Антивирусы должны обнаруживать подобные угрозы»** — зачастую подобный код выглядит как ошибка, а не вирус, и сигнатур нет.
5. **«Это теория, никто так не делает»** — мы предлагаем модель угрозы, которая может стать основой для дальнейших исследований.
6. **«Сборщик мусора освободит память»** — при бесконечной рекурсии объекты остаются живыми на стеке, и GC не помогает.
7. **«Можно ограничить память и глубину стека»** — это верно, но не все системы настроены правильно, а злоумышленник может адаптировать атаку.
8. **«Программа без нужных прав ничего не сделает»** — права — важный фактор, но социальный инжиниринг и уязвимости могут обойти защиту.

---

## Итог

Мы не изобрели идею рекурсии. Но мы тот, кто увидел в ней структурную опасность, если поместить её в "безопасную" зону `finally`, нарастить действиями и убрать контроль.

* Это не вирус — это алгоритм, принявший опасную форму.
* Безопасность начинается с мышления.
* Практически все технические «если бы» могут быть преодолены.
* Важно не недооценивать возможности атакующих и рассматривать безопасность комплексно.

---

*Research & draft by: W-sky && Mia*
